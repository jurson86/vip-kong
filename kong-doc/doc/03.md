# TGW  实战

##  简介
####  什么是KGW    

**网关原始定义**：   
网关的英文名称：gateway，又叫做网间连接器、协议转换器。
网关是在采用不同体系结构或协议的网络之间进行互通时，用于提供协议转换、路由选择等网络兼容功能的设施。

**基础功能：**  协议转换，路由选择，网络转换；

随着业务的发展，尤其是微服务的出现，应用层面的网关随之出现，整合业务层面的基础功能。

例如:

1. **统一接入：**网关对外包括ios、android、webapp、website、h5、微信小程序甚至是第三方提供一个统一服务接入入口。
2. **服务编排:**  客户端通过网关统一开放的接口，来提供各类业务的服务；
3. **安全策略：**   保护后端服务，提供流量控制、服务降级、访问控制（ACL）、鉴权机制，攻击识别等。
4. **API管理平台：** API的配置、灰度测试、发布、修改、下线。
5. **安全防护（WAF）:**  API审计，通过API层面的监控，数据分析采取主被动防御，从而做到对访问内容安全识别的支撑。


**KGW主要包含服务**：    
<pre>
Register Eureka : 微服务注册中心；
Register Redis : kong集群注册中心；不同业务主体，可注册为不同的kong服务集群。
PostgreSQL   ：kong集群配置中心，用来存储配置基础数据。     
Kong Service ：基于nginx的服务器，用来处理API请求。    
Kong Admin ：ADMIN控制台，使用 restfull 方式管理kong集群; 整合微服务注册中心Eureka 到kong集群；
Kong Authservice ： 身份认证，权限管理插件用到的支撑服务。
</pre>
**组件之间的关系**：     
<pre>
Kong Admin  与 Register  Eureka  ，  Register Redis 同组一一匹配的关系；     

Kong Service 与 PostgreSQL 同集群一一匹配的关系

Kong Admin组 与 Kong Service集群为 一对多的关系；

插件支撑服务与插件接口由插件配置定义匹配关系，如： Kong Authservice 
</pre>

![033](03_images\033.png)

####  为什么要用KGW  

Kong是一个著名的API网关轮子，直接在Kong的基础上来构建自己的API 网关系统

原始架构方案：
  
![034](03_images\034.png)

接入网关架构：

![035](03_images\035.png)

Kong采用插件机制进行功能定制，插件集（可以是0或N个）在API请求响应循环的生命周期中被执行。采用插件方式实现网关特性，能非常灵活的整合其基础功能。

插件使用Lua编写，Lua脚本性语言，非常利于配置变更及解读。

目前已有基础插件：API自定义秘钥双向加解密， 身份认证、基于角色的权限管理、链路跟踪监控、停服维护、客户端限流、黑白名单等。



