##  网关升级
 
###  普通升级
**定义：**

普通升级是指，网关内部功能变更，并不影响到： 客户端，服务端对接协议，网关自身升级即可；


**约束：**

网关主体功能变更需要升级主体版本号，主体包含：kong，kong-admin

网关插件功能变更需要升级插件版本号，插件版本号需要放入插件名称里面，如： tdwrsa-v1 ，tdwrsa-v2

**方案：**

- 业务网关所有主体组件，都通过高可用方案部署；

- 业务网关前置一个路由分发网关，升级过程统一采用蓝绿发布方案完成。


![60](60_images\60.png)


### 关联升级

**定义：**

关联升级是指，网关功能变更，影响到客户端或服务端对接协议，由此导致网关及协议相关方都必须按要求执行升级方案；


**约束：**

网关主体功能变更需要升级主体版本号，主体包含：kong，kong-admin

网关插件功能变更需要升级插件版本号，插件版本号需要放入插件名称里面，如： tdwrsa-v1 ，tdwrsa-v2

外部服务对接，必须按对接协议执行：具体详见《API客户端对接【13】》

- URL： 
  - 格式： [http | https]://{域名}/{接口版本号}/{接口服务名}/[auth | nuauth]/{URI}
  - 必要： 接口服务名，接口版本号（网关端控制），认证标识(auth | unauth)
  - 注： 接口版本号由网关端控制，以便匹配网关端功能升级；业务端可以在URI里面加入版本号，控制业务端功能升级；
  - 接口服务名：统一有kong-admin管理，登记服务名，负责人，联系方式，对外发布时间，备注信息
  - 接口版本号：格式 v1，v2，vn... 以此类推



**方案：**

- 业务网关所有主体组件，需要部署两组服务，分别为老版本 和 新版本；

- 业务网关再前置一个路由分发网关，将新版本接口路由到新业务网关组，旧版本接口路由到老版本业务网关组；

- 公告业务相关方在一定时间段完成对接升级，待老版本业务网关流量减少后，再关闭老版本网关服务。

![602](60_images\602.png)
